<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…è²»è¼•é¬†è¨˜ | æ—¥ç³»æ¥µç°¡åˆ†å¸³å°å·¥å…·</title>

<!-- iOS åŠ å…¥ä¸»ç•«é¢ Icon -->
<link rel="apple-touch-icon" href="cal.png">

<!-- iOS PWA åŸºæœ¬è¨­å®š -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="æ—…è²»è¼•é¬†è¨˜">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        beige: {
                            DEFAULT: '#FEF8EA',
                            dark: '#EBE4D5'
                        },
                        primary: '#85A389', // æŸ”å’Œçš„é¼ å°¾è‰ç¶ 
                        primaryDark: '#708E74',
                        textMain: '#4A4A4A',
                        textSub: '#9CA3AF',
                        danger: '#E78895'
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #FEF8EA;
            color: #4A4A4A;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        /* éš±è—æ²è»¸ä½†ä¿æŒå¯æ²å‹• */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* æ¨¡æ…‹æ¡†éæ¸¡å‹•ç•« */
        .modal-enter-active, .modal-leave-active {
            transition: all 0.3s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
            transform: translateY(100%);
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.2s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body class="antialiased overflow-hidden">
    <div id="app" class="max-w-md mx-auto h-[100dvh] bg-beige relative shadow-xl overflow-hidden flex flex-col">
        
        <!-- é ‚éƒ¨å°èˆªåˆ— -->
        <header class="pt-12 pb-4 px-6 flex justify-between items-center z-10 sticky top-0 bg-beige bg-opacity-90 backdrop-blur-sm">
            <h1 class="text-xl font-bold tracking-wider text-textMain">{{ tabTitles[activeTab] }}</h1>
            <button @click="confirmClearAll" class="p-2 rounded-full text-textSub hover:text-danger hover:bg-red-50 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
            </button>
        </header>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <main class="flex-1 overflow-y-auto no-scrollbar px-6 pb-24">
            
            <!-- 1. å‡ºå¸­è³‡æ–™ (Participants) -->
            <div v-show="activeTab === 'participants'" class="space-y-6 animate-fade-in">
                <div class="bg-white p-6 rounded-3xl shadow-soft">
                    <label class="block text-sm font-medium text-textSub mb-2">å‡ºå¸­äººæ•¸</label>
                    <select v-model="numPeople" @change="updatePeopleList" class="w-full bg-beige-dark bg-opacity-30 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-primary appearance-none text-lg">
                        <option v-for="n in 5" :key="n" :value="n+1">{{ n+1 }} äºº</option>
                    </select>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-soft space-y-4">
                    <h2 class="text-sm font-medium text-textSub mb-4">è¼¸å…¥å‡ºå¸­è€…åç¨±</h2>
                    <div v-for="(person, index) in people" :key="index" class="relative">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <span class="text-primary font-bold">{{ index + 1 }}</span>
                        </div>
                        <input type="text" v-model="people[index]" :placeholder="'æœ‹å‹ ' + (index + 1)" class="w-full bg-beige-dark bg-opacity-30 rounded-xl pl-10 pr-4 py-3 outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>
            </div>

            <!-- 2. è¡Œç¨‹å…¬è²» (Shared Expenses) -->
            <div v-show="activeTab === 'shared'" class="space-y-6">
                <!-- ç¸½è¨ˆå¡ç‰‡ -->
                <div class="bg-white p-6 rounded-3xl shadow-soft">
                    <h2 class="text-sm font-medium text-textSub mb-2">ç¸½å…¬è²»èŠ±è²»</h2>
                    <div v-if="Object.keys(sharedTotals).length === 0" class="text-2xl font-bold text-gray-300">0.00</div>
                    <div v-else class="space-y-2">
                        <div v-for="(total, currency) in sharedTotals" :key="currency" class="flex justify-between items-end">
                            <span class="text-sm text-textSub">{{ currency }}</span>
                            <span class="text-2xl font-bold text-primary">{{ formatMoney(total) }}</span>
                        </div>
                    </div>
                </div>

                <!-- åˆ—è¡¨ -->
                <div class="space-y-3">
                    <div v-if="shared.length === 0" class="text-center py-10 text-textSub text-sm">
                        å°šæœªæœ‰ä»»ä½•è¨˜å¸³ï¼ŒæŒ‰å³ä¸‹æ–¹ + è™Ÿæ–°å¢å§ï¼
                    </div>
                    <div v-for="item in sortedShared" :key="item.id" class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center relative overflow-hidden group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-beige flex items-center justify-center text-primary text-sm font-bold">
                                {{ getCategoryIcon(item.category) }}
                            </div>
                            <div>
                                <div class="font-medium text-textMain">{{ item.name }}</div>
                                <div class="text-xs text-textSub mt-0.5">{{ item.date }} Â· {{ item.payer }} ä»˜æ¬¾ ({{ item.paymentMethod }})</div>
                            </div>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <div class="font-bold text-textMain">{{ item.currency }} {{ formatMoney(item.amount) }}</div>
                            <button @click="deleteItem('shared', item.id)" class="text-xs text-danger mt-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. åˆ†æ“”è¨ˆç®— (Split) -->
            <div v-show="activeTab === 'split'" class="space-y-6">
                <div v-if="!hasSharedData" class="text-center py-20 text-textSub">
                    <div class="mb-4 text-4xl">ğŸ§®</div>
                    <p>éœ€è¦å…ˆåœ¨ã€Œå…¬è²»ã€åŠ å…¥é …ç›®æ‰èƒ½è¨ˆç®—å–”ï¼</p>
                </div>
                
                <div v-else v-for="(data, currency) in splitData" :key="currency" class="bg-white p-6 rounded-3xl shadow-soft">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-beige-dark border-opacity-50">
                        <div class="font-bold text-lg">{{ currency }} çµç®—</div>
                        <div class="text-sm text-textSub">ç¸½é¡: {{ formatMoney(data.total) }}<br>å¹³å‡: {{ formatMoney(data.average) }}/äºº</div>
                    </div>

                    <div class="space-y-4">
                        <div v-for="person in data.details" :key="person.name" class="flex justify-between items-center">
                            <div>
                                <div class="font-medium text-textMain">{{ person.name }}</div>
                                <div class="text-xs text-textSub">å·²ä»£ä»˜: {{ formatMoney(person.paid) }}</div>
                            </div>
                            <div class="text-right">
                                <span v-if="person.balance === 0" class="text-sm text-textSub bg-beige px-3 py-1 rounded-full">ç„¡é ˆæ”¶ä»˜</span>
                                <span v-else-if="person.balance > 0" class="text-sm text-primary font-bold bg-green-50 px-3 py-1 rounded-full">
                                    éœ€æ”¶å› +{{ formatMoney(person.balance) }}
                                </span>
                                <span v-else class="text-sm text-danger font-bold bg-red-50 px-3 py-1 rounded-full">
                                    éœ€è£œå› {{ formatMoney(Math.abs(person.balance)) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. å€‹äººæ”¯å‡º (Personal) -->
            <div v-show="activeTab === 'personal'" class="space-y-6">
                <!-- ç¸½è¨ˆå¡ç‰‡ -->
                <div class="bg-white p-6 rounded-3xl shadow-soft">
                    <h2 class="text-sm font-medium text-textSub mb-2">ç¸½å€‹äººæ”¯å‡º</h2>
                    <div v-if="Object.keys(personalTotals).length === 0" class="text-2xl font-bold text-gray-300">0.00</div>
                    <div v-else class="space-y-2">
                        <div v-for="(total, currency) in personalTotals" :key="currency" class="flex justify-between items-end">
                            <span class="text-sm text-textSub">{{ currency }}</span>
                            <span class="text-2xl font-bold text-textMain">{{ formatMoney(total) }}</span>
                        </div>
                    </div>
                </div>

                <!-- åˆ—è¡¨ -->
                <div class="space-y-3">
                    <div v-if="personal.length === 0" class="text-center py-10 text-textSub text-sm">
                        å°šæœªæœ‰ä»»ä½•å€‹äººèŠ±è²»ã€‚
                    </div>
                    <div v-for="item in sortedPersonal" :key="item.id" class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-beige flex items-center justify-center text-textMain text-sm font-bold">
                                {{ getCategoryIcon(item.category) }}
                            </div>
                            <div>
                                <div class="font-medium text-textMain">{{ item.name }}</div>
                                <div class="text-xs text-textSub mt-0.5">{{ item.date }}</div>
                            </div>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <div class="font-bold text-textMain">{{ item.currency }} {{ formatMoney(item.amount) }}</div>
                            <button @click="deleteItem('personal', item.id)" class="text-xs text-danger mt-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- æµ®å‹•æ–°å¢æŒ‰éˆ• (FAB) -->
        <button v-show="activeTab === 'shared' || activeTab === 'personal'" 
                @click="openAddModal"
                class="absolute bottom-24 right-6 w-14 h-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center hover:bg-primaryDark transition transform hover:scale-105 z-20">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>

        <!-- åº•éƒ¨å°èˆª -->
        <nav class="absolute bottom-0 w-full bg-white border-t border-gray-100 flex justify-around items-center pb-safe pt-2 px-2 z-20 rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.02)] h-20">
            <button @click="activeTab = 'participants'" class="flex flex-col items-center p-2 w-16 transition-colors" :class="activeTab === 'participants' ? 'text-primary' : 'text-textSub'">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                <span class="text-[10px] font-medium">åŒè¡Œ</span>
            </button>
            <button @click="activeTab = 'shared'" class="flex flex-col items-center p-2 w-16 transition-colors" :class="activeTab === 'shared' ? 'text-primary' : 'text-textSub'">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-1"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                <span class="text-[10px] font-medium">å…¬è²»</span>
            </button>
            <button @click="activeTab = 'split'" class="flex flex-col items-center p-2 w-16 transition-colors" :class="activeTab === 'split' ? 'text-primary' : 'text-textSub'">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-1"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><line x1="12" y1="18" x2="12" y2="22"></line><line x1="12" y1="2" x2="12" y2="6"></line></svg>
                <span class="text-[10px] font-medium">æ‹†å¸³</span>
            </button>
            <button @click="activeTab = 'personal'" class="flex flex-col items-center p-2 w-16 transition-colors" :class="activeTab === 'personal' ? 'text-primary' : 'text-textSub'">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mb-1"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                <span class="text-[10px] font-medium">å€‹äºº</span>
            </button>
        </nav>

        <!-- æ–°å¢è¨˜å¸³ Modal (Bottom Sheet) -->
        <transition name="fade">
            <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-30 z-40" @click="closeModal"></div>
        </transition>
        <transition name="modal">
            <div v-if="showModal" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white rounded-t-3xl z-50 p-6 shadow-2xl pb-safe flex flex-col" style="max-height: 90vh;">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold">{{ activeTab === 'shared' ? 'æ–°å¢å…¬è²»' : 'æ–°å¢å€‹äººæ”¯å‡º' }}</h3>
                    <button @click="closeModal" class="p-2 text-textSub bg-beige rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>

                <div class="overflow-y-auto no-scrollbar space-y-4 pb-4">
                    <!-- è¡¨å–®å…§å®¹ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-textSub mb-1 ml-1">é¡åˆ¥</label>
                            <select v-model="form.category" class="w-full bg-beige bg-opacity-50 rounded-xl px-4 py-3 outline-none focus:bg-beige appearance-none">
                                <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-textSub mb-1 ml-1">æ—¥æœŸ</label>
                            <input type="date" v-model="form.date" class="w-full bg-beige bg-opacity-50 rounded-xl px-4 py-3 outline-none focus:bg-beige appearance-none text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-textSub mb-1 ml-1">é …ç›®åç¨±</label>
                        <input type="text" v-model="form.name" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€çš„å£«" class="w-full bg-beige bg-opacity-50 rounded-xl px-4 py-3 outline-none focus:bg-beige">
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-1">
                            <label class="block text-xs text-textSub mb-1 ml-1">è²¨å¹£</label>
                            <select v-model="form.currency" class="w-full bg-beige bg-opacity-50 rounded-xl px-3 py-3 outline-none focus:bg-beige appearance-none">
                                <option v-for="cur in currencies" :key="cur" :value="cur">{{ cur }}</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-textSub mb-1 ml-1">é‡‘é¡</label>
                            <input type="number" v-model.number="form.amount" placeholder="0.00" step="0.01" min="0" class="w-full bg-beige bg-opacity-50 rounded-xl px-4 py-3 outline-none focus:bg-beige font-bold text-lg text-primary">
                        </div>
                    </div>

                    <template v-if="activeTab === 'shared'">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-textSub mb-1 ml-1">ä»˜æ¬¾æ–¹å¼</label>
                                <select v-model="form.paymentMethod" class="w-full bg-beige bg-opacity-50 rounded-xl px-4 py-3 outline-none focus:bg-beige appearance-none">
                                    <option v-for="pm in payMethods" :key="pm" :value="pm">{{ pm }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-textSub mb-1 ml-1">èª°ä»˜æ¬¾ï¼Ÿ</label>
                                <select v-model="form.payer" class="w-full bg-beige bg-opacity-50 rounded-xl px-4 py-3 outline-none focus:bg-beige appearance-none">
                                    <option v-for="person in validPeople" :key="person" :value="person">{{ person }}</option>
                                </select>
                            </div>
                        </div>
                    </template>
                </div>
                
                <button @click="saveExpense" class="mt-4 w-full bg-primary text-white font-bold py-4 rounded-xl shadow-md hover:bg-primaryDark transition disabled:opacity-50 disabled:cursor-not-allowed" :disabled="!isFormValid">
                    å„²å­˜è¨˜éŒ„
                </button>
            </div>
        </transition>

        <!-- æ¸…é™¤ç¢ºèª Modal -->
        <transition name="fade">
            <div v-if="showClearConfirm" class="fixed inset-0 bg-black bg-opacity-40 z-[60] flex items-center justify-center p-4">
                <div class="bg-white rounded-3xl p-6 w-full max-w-xs text-center shadow-2xl">
                    <div class="w-16 h-16 bg-red-50 text-danger rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 11V17"></path><path d="M14 11V17"></path><path d="M4 7H20"></path><path d="M6 7H12H18V18C18 19.6569 16.6569 21 15 21H9C7.34315 21 6 19.6569 6 18V7Z"></path><path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z"></path></svg>
                    </div>
                    <h3 class="text-lg font-bold mb-2">ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ</h3>
                    <p class="text-sm text-textSub mb-6">é€™å°‡æœƒåˆªé™¤æ‰€æœ‰å·²è¼¸å…¥çš„æœ‹å‹åå–®åŠè¨˜å¸³ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚</p>
                    <div class="flex gap-3">
                        <button @click="showClearConfirm = false" class="flex-1 py-3 rounded-xl bg-beige text-textMain font-medium">å–æ¶ˆ</button>
                        <button @click="clearAllData" class="flex-1 py-3 rounded-xl bg-danger text-white font-medium shadow-md">ä¸€éµæ¸…é™¤</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                const STORAGE_KEY = 'travel-expense-app-v1';
                const today = new Date().toISOString().split('T')[0];

                // ç‹€æ…‹
                const activeTab = ref('participants');
                const tabTitles = {
                    participants: 'åŒè¡Œæœ‹å‹',
                    shared: 'å…¬è²»è¨˜å¸³',
                    split: 'åˆ†æ“”è¨ˆç®—',
                    personal: 'å€‹äººè¨˜å¸³'
                };

                const numPeople = ref(2);
                const people = ref(['', '']);
                
                const currencies = ['HKD', 'JPY', 'KRW', 'THB', 'TWD', 'CNY'];
                const categories = ['äº¤é€š', 'é£²é£Ÿ', 'ä½å®¿', 'é–€ç¥¨', 'è³¼ç‰©', 'å…¶ä»–'];
                const payMethods = ['ç¾é‡‘', 'ä¿¡ç”¨å¡'];

                const shared = ref([]);
                const personal = ref([]);

                const showModal = ref(false);
                const showClearConfirm = ref(false);

                // è¡¨å–®ç‹€æ…‹
                const initialForm = () => ({
                    id: null,
                    category: 'é£²é£Ÿ',
                    name: '',
                    date: today,
                    currency: 'HKD',
                    amount: null,
                    paymentMethod: 'ç¾é‡‘',
                    payer: '' // å°‡åœ¨æ‰“é–‹æ™‚è¨­å®šé è¨­å€¼
                });
                const form = ref(initialForm());

                // ç›£è½äººæ•¸è®Šæ›´ï¼Œæ›´æ–°åå–®é•·åº¦
                const updatePeopleList = () => {
                    const currentLen = people.value.length;
                    const newLen = parseInt(numPeople.value);
                    if (newLen > currentLen) {
                        for (let i = currentLen; i < newLen; i++) {
                            people.value.push('');
                        }
                    } else if (newLen < currentLen) {
                        people.value = people.value.slice(0, newLen);
                    }
                };

                // éæ¿¾æ‰ç©ºç™½åå­—ï¼Œé¿å…ä¸‹æ‹‰é¸å–®å‡ºç¾ç©ºç™½
                const validPeople = computed(() => {
                    return people.value.map((p, i) => p.trim() || `æœ‹å‹ ${i+1}`);
                });

                // è¨ˆç®—ç¸½è¨ˆ (å…±ç”¨é‚è¼¯)
                const calcTotals = (items) => {
                    return items.reduce((acc, item) => {
                        if (!acc[item.currency]) acc[item.currency] = 0;
                        acc[item.currency] += Number(item.amount);
                        return acc;
                    }, {});
                };

                const sharedTotals = computed(() => calcTotals(shared.value));
                const personalTotals = computed(() => calcTotals(personal.value));

                // æ’åºåˆ—è¡¨ (æœ€æ–°åœ¨ä¸Š)
                const sortedShared = computed(() => [...shared.value].reverse());
                const sortedPersonal = computed(() => [...personal.value].reverse());

                const hasSharedData = computed(() => shared.value.length > 0);

                // æ ¸å¿ƒï¼šåˆ†æ“”è¨ˆç®—é‚è¼¯
                const splitData = computed(() => {
                    if (!hasSharedData.value) return {};

                    const result = {};
                    const currsPresent = new Set(shared.value.map(item => item.currency));

                    currsPresent.forEach(currency => {
                        let total = 0;
                        const paidMap = {};
                        
                        // åˆå§‹åŒ–æ¯äººå·²ä»˜ç‚º 0
                        validPeople.value.forEach(p => paidMap[p] = 0);

                        // è¨ˆç®—ç¸½é¡åŠæ¯äººä»£ä»˜é¡
                        shared.value.forEach(item => {
                            if (item.currency === currency) {
                                total += item.amount;
                                // è‹¥ payer åç¨±è¢«ä¿®æ”¹éæ‰¾ä¸åˆ°ï¼Œå‰‡æ­¸é¡åˆ°ç¬¬ä¸€å€‹äºº (é˜²å‘†)
                                const actualPayer = paidMap[item.payer] !== undefined ? item.payer : validPeople.value[0];
                                paidMap[actualPayer] += item.amount;
                            }
                        });

                        if (total > 0) {
                            const average = total / validPeople.value.length;
                            const details = validPeople.value.map(person => {
                                const paid = paidMap[person];
                                const balance = paid - average; // æ­£æ•¸=éœ€æ”¶å›ï¼Œè² æ•¸=éœ€è£œå›
                                return {
                                    name: person,
                                    paid: paid,
                                    balance: balance
                                };
                            });

                            result[currency] = {
                                total,
                                average,
                                details
                            };
                        }
                    });

                    return result;
                });

                // Modal æ“ä½œ
                const openAddModal = () => {
                    form.value = initialForm();
                    // é è¨­ payer ç‚ºç¬¬ä¸€å€‹äºº
                    form.value.payer = validPeople.value[0];
                    showModal.value = true;
                };

                const closeModal = () => {
                    showModal.value = false;
                };

                const isFormValid = computed(() => {
                    return form.value.name.trim() !== '' && form.value.amount > 0;
                });

                const saveExpense = () => {
                    if (!isFormValid.value) return;

                    const newItem = {
                        ...form.value,
                        id: Date.now(),
                        amount: Number(form.value.amount)
                    };

                    if (activeTab.value === 'shared') {
                        // ç¢ºä¿ä½¿ç”¨ç•¶ä¸‹æœ‰æ•ˆçš„äººå
                        newItem.payer = validPeople.value.includes(newItem.payer) ? newItem.payer : validPeople.value[0];
                        shared.value.push(newItem);
                    } else {
                        personal.value.push(newItem);
                    }
                    closeModal();
                };

                const deleteItem = (type, id) => {
                    if (type === 'shared') {
                        shared.value = shared.value.filter(i => i.id !== id);
                    } else {
                        personal.value = personal.value.filter(i => i.id !== id);
                    }
                };

                // æ¸…é™¤å…¨éƒ¨è³‡æ–™
                const confirmClearAll = () => {
                    showClearConfirm.value = true;
                };

                const clearAllData = () => {
                    numPeople.value = 2;
                    people.value = ['', ''];
                    shared.value = [];
                    personal.value = [];
                    activeTab.value = 'participants';
                    showClearConfirm.value = false;
                    localStorage.removeItem(STORAGE_KEY);
                };

                // è¼”åŠ©å‡½æ•¸
                const formatMoney = (val) => {
                    return Number(val).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                };

                const getCategoryIcon = (cat) => {
                    const icons = {
                        'äº¤é€š': 'ğŸšŒ',
                        'é£²é£Ÿ': 'ğŸ¥¢',
                        'ä½å®¿': 'ğŸ›ï¸',
                        'é–€ç¥¨': 'ğŸ«',
                        'è³¼ç‰©': 'ğŸ›ï¸',
                        'å…¶ä»–': 'âœ¨'
                    };
                    return icons[cat] || 'âœ¨';
                };
        //localStorage è¼‰å…¥
        onMounted(() => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            try {
                const data = JSON.parse(saved);
                activeTab.value = data.activeTab ?? 'participants';
                numPeople.value = data.numPeople ?? 2;
                people.value = data.people ?? ['æœ‹å‹ 1', 'æœ‹å‹ 2'];
                shared.value = data.shared ?? [];
                personal.value = data.personal ?? [];
            } catch (e) {
                console.warn('localStorage è³‡æ–™éŒ¯èª¤ï¼Œå·²å¿½ç•¥');
            }
        });

        //localStorage è‡ªå‹•å„²å­˜

        watch(
            [activeTab, numPeople, people, shared, personal],
            () => {
                localStorage.setItem(
                    STORAGE_KEY,
                    JSON.stringify({
                        activeTab: activeTab.value,
                        numPeople: numPeople.value,
                        people: people.value,
                        shared: shared.value,
                        personal: personal.value
                    })
                );
            },
            { deep: true }
        );

                return {
                    activeTab, tabTitles,
                    numPeople, people, updatePeopleList, validPeople,
                    currencies, categories, payMethods,
                    shared, personal,
                    sharedTotals, personalTotals, sortedShared, sortedPersonal,
                    splitData, hasSharedData,
                    showModal, form, openAddModal, closeModal, isFormValid, saveExpense, deleteItem,
                    showClearConfirm, confirmClearAll, clearAllData,
                    formatMoney, getCategoryIcon
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
